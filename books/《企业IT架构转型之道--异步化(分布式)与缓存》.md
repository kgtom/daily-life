---


---

<h2 id="异步化与缓存">异步化与缓存</h2>
<h3 id="本章知识点">本章知识点</h3>
<ul>
<li>
<p>分布式服务架构中，如何通过业务流程异步化，即服务异步的方式调用，解决大量同步方式带来的性能问题？</p>
</li>
<li>
<p>数据进行分库分表后，数据在异步操作的情况下，如何解决分布式事务一致性问题？</p>
</li>
<li>
<p>通过商品秒杀场景，说明缓存技术的重要性</p>
</li>
</ul>
<h3 id="一.业务流程异步化">一.业务流程异步化</h3>
<ul>
<li>
<p>业务流程举例：下单流程，库存检查–&gt;库存预减–&gt;订单生成—&gt;支付生成—&gt;其它服务(日志、物流等)<br>
异步处理：下单后，返回订单创建成功，其它支付、物流采用消息中间件(MQ)通知</p>
</li>
<li>
<p>OA审批举例：最后一个节点审批成功后，发送消息到消息队列，MQ消费端获取到消息再通知审批流程所有人</p>
</li>
</ul>
<p><strong>问题</strong>  库存减少是商品服务中心功能模块，支付成功属于支付宝api，如何保证两者同时成功或者失败？</p>
<p><strong>回答</strong>  问题实质 如何保证分布式事务一致性，答案继续往下看</p>
<h3 id="二.数据库事务异步化">二.数据库事务异步化</h3>
<p>** 背景**：大的数据库事务对数据库资源、表记录长时间被事务锁住带来数据库请求排队</p>
<p><strong>解决</strong>：大事务分集成小事务，减少资源占用，提高吞吐量及事务操作的响应时间</p>
<p><strong>举例</strong>：月底清算客户退款余额，涉及到四张表(订单表状态(已退款)、客户余额增加、增加客户明细记录，公司账号余额减少)，如果同时1000用户，同时1000*4=4000次db操作 ，数据库压力大。</p>
<p><strong>解决</strong>: 采用MQ中间件方式，用户发起 退款后，将消息发送到MQ，1.退款开始，发送退款计算消息，2.收到消息，计算退款金额，发送退款计划 ，3.收到消息，给客户转账，发送消息订单、明细的处理，4.收到消息，余额操作等</p>
<p>**问题 **: 同样也是如何保证分布式事务一致性</p>
<p><strong>回答</strong>：理论基础： ACID 、BASE、CAP，强两者“酸碱理论”，后者名“帽子理论”</p>
<ul>
<li>
<p>传统分布式事务：采用两阶段提交或者TCC三阶段提交</p>
</li>
<li>
<p>互联网分布式事务：</p>
<ul>
<li>引入日志(事务开始、结束日志及数据REDO/UNDO,当事务重试、回滚时，根据日志最终将数据恢复到一致性)及补偿机制，根据CAP，结合业务通常牺牲一致性，追求最终一致性</li>
<li>可靠的信息传递，消息传递有三种状态：成功、失败、不知道成功还是失败。投递有两种方式(仅投递一次、至少投递一次(幂等性，记录业务编号，建立排重表))</li>
<li>实现无锁，两种方式
<ul>
<li>建立辅助业务明细表。例如：下单成功后，不去减少库存，而是记录库存增减明细表，等支付成功后，再去更新库存数量。</li>
<li>使用版本号的方式实现乐观锁。表中记录版本号字段，事务开始前获取到版本号，事务最后update是获取版本号，如何两者一致则继续更新，否则说明其它事务有修改，放弃本次事务。这种好处避免了长事务中的数据库加锁开销。</li>
</ul>
</li>
</ul>
<h3 id="总结阿里做法：">总结阿里做法：</h3>
<ul>
<li>分布式MQ队列，解耦模板，提高业务处理的吞吐率和响应时间。例如：下单(检查库存数量)—&gt; mq—&gt;支付操作–&gt;mq—&gt;库存减少场景.</li>
<li>TCC 典型事后补偿<br>
<strong>注意点</strong>：幂等及各个模块之间异步消息来驱动</li>
</ul>
</li>
</ul>
<h3 id="三、缓存使用">三、缓存使用</h3>
<h2 id="下一章：打造数字化运营能力">下一章：打造数字化运营能力</h2>
<blockquote>
<p>reference:<br>
《企业IT架构转型之道》</p>
</blockquote>

