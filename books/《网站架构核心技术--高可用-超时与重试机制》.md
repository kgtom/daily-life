## 学习大纲
* [一、背景](#1)
* [二、代理层(Nginx)超时与重试](#2)
* [三、中间件客户端超时](#3)
* [四、数据库客户端超时](#4)
* [五、NoSql 客户端超时](#5)
* [六、业务超时](#6)
* [七、前端Ajax超时](#7)
* [八、总结](#8)

## <span id="1"> 一、背景</span>
* 在实际开发过程中，因为没有设置超时时间或者设置超时时间不合理，导致系统故障。这些故障导致请求慢，而慢请求累计导致连锁反应，甚至造成应用雪崩。
* 中间件或者框架在超时后会进行重试(一般两次)，读服务适合重试，但写服务，尤其新增订单，如果是幂等的，则重试是允许的，其它的会导致多倍请求，即模拟了DDos攻击。
* 所以 在review时候设置重试机制非常重要，主要设置在于**网络链接、读、写请求**。
## <span id="2"> 二、代理层(Nginx)超时与重试</span>
### nginx 主要四类超时
* 1.客户端超时设置
   - 读取请求头超时时间 client_header_timeout time
   - 读取请求体超时时间 client_body_timeout time 
   - 发送响应超时时间  send_timeout time
   - http长连接超时时间 keepalive_timeout time  :如果是短的请求处理，则设置短一点，如果像文件上传，则设置长一点
 
* 2.DNS解析超时设置

   resolver_timeout time 30s：设置dns解析超时时间，默认30s.
* 3.代理超时设置
* 4.ngx_lua模块中lua超时设置

## <span id="3"> 三、中间件客户端超时</span>
设置请求时间，例如Gin ReadTimeout、WriteTimeout

## <span id="4"> 四、数据库客户端超时</span>
使用数据库客户端时，我们会用到数据库连接池，以mysql为例，有以下设置
connectiontTimeout socketTimeout 及网关连接读取时间 connectionProperties


## <span id="5"> 五、NoSql 客户端超时</span>
* MongoDB:conncet-timeout 、socket-timeout
* Redis:setTimeout 、setMaxWaitMillis


## <span id="6"> 六、业务超时</span>
* 任务型：如未支付，超时后 自动取消订单
* 服务调用型：例如全局调用超时时间 500ms,调用某个api时，可能需要3000ms,需要单独设置。

## <span id="7"> 七、前端Ajax超时</span>
~~~js
$.ajax({
...
timeout:2000,
...
})

~~~


## <span id="8"> 八、总结</span>
 本节主要介绍web应用访问的整个链路上进行超时时间设置。通过配置合理的超时时间，防止出现某个服务的依赖超时时间太长且响应慢，以致自己响应慢设置崩溃。
 
* 1.客户端和服务端都应该设置超时时间。根据场景设置，有时候需要客户端超时时间>服务端超时时间。如果存在多级依赖，如A调用B,B调用C,则超时时间应该A>B>C。有时候客户端超时时间<服务端，可以通过在服务端实施限流、降级防止DDoS攻击。
 * 2.超时后重试策略，过一会再重试、托底数据、等待页面、错误页面
 * 3.对于非幂等写服务应避免重试，或者可以考虑提前生成唯一流水号来保证写服务是否幂等操作。
 * 4.数据库/缓存设置超时时，要经常检查慢查询，超时严重的，可以采取服务降级，待服务恢复后再取消降级
 * 5.对于负载均衡的中间件，考虑配置心跳/存活检查
 * 6.根据实际场景，合理设置超时时间，例如：商品详情页库存状态的服务，超时时间设置短一些，但超时时返回有货，而结算页面设置长一些，等待查询库存状态结果，返回真实的库存状态。
