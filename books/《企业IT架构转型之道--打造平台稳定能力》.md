---


---

<h2 id="打造平台稳定能力">打造平台稳定能力</h2>
<h3 id="前言">前言</h3>
<p>本章主要从共享服务中台的角度，如何打造平台稳定性，主要从以下几个方面：</p>
<ul>
<li>一、限流和降级</li>
<li>二、流量调度</li>
<li>三、业务开关</li>
<li>四、容量压测和评估</li>
<li>五、全链路压测平台</li>
<li>六、业务一致性平台</li>
</ul>
<h3 id="一、限流和降级">一、限流和降级</h3>
<p><strong>限流</strong>作用相当于电路上的保险丝，当过载的时候掐掉一部分流量，让系统有能力集中资源以较快的速度处理平台能力范围的业务。<br>
<strong>场景</strong>：</p>
<ul>
<li>
<ol>
<li>一个核心api，会有很多应用调用，如果对服务的调用不加限制的使用，会造成请求占满，响应超时，服务故障。</li>
</ol>
</li>
<li>
<ol start="2">
<li>大促活动场景，预估100w人参与，结果1000w人瞬间涌来，大量资源抢占和服务器上下文切换<br>
<strong>做法</strong>最关键的不是监控cup、内存、IO是否过载(因为很多情况下系统本身的处理能力跟操作系统资源的使用情况没有一个很清晰的定位)，而是找到最合适的QPS.</li>
</ol>
</li>
<li>
<p>前端：<br>
Nginx上扩展组件，实现接入层限流，通过域名类限流、cookie限流、黑名单方式</p>
</li>
<li>
<p>后端：<br>
一种action拦截器，计算目前线程或者qps与所设置最大数比较，如果大于返回异常信息。这种做法简单，一个应用可以这么写，100应用要是写100拦截器就算了吧，另外缺少监控平台，不能全局掌控。</p>
</li>
<li>
<p>另一种Sentine 哨兵平台实现 授权、限流、降级(非核心功能暂停)、监控</p>
</li>
</ul>
<h3 id="二、流量调度">二、流量调度</h3>
<p><strong>背景</strong></p>
<ul>
<li>分布式服务环境调用局部问题会被放大到整个链路，在分布式环境中，硬件、软件、网络等导致机器的实时服务能力有所差异。一次网络抖动或者cpu超配都会引起。</li>
</ul>
<p><strong>实现原理</strong><br>
通过秒级获取服务器运行指标及业务指标，通过流量平台设置决策算法和规则，满足条件的服务器进行下线或者降级操作。</p>
<h3 id="三、业务开关">三、业务开关</h3>
<p><strong>做法</strong>将每一个系统的业务开关(配置文件值)统一到集团层面，建立业务开关平台统一处理。<br>
<strong>作用</strong>  在大促、秒杀、应用异常时，业务开关服务起到降级的作用。</p>
<h3 id="四、容量压测及评估规划">四、容量压测及评估规划</h3>
<p>传统测试方法<strong>缺陷</strong>：场景测试不够真实<br>
<strong>现在采用</strong>：将生产环境的流量模型引流到压测服务器上，获取到服务实例单机最大处理能力(包括QPS、CPU利用率、相应时间等)，结合不同型号服务器处理能力以及生产环境的水位监控信息，对服务集群所需部署的服务器数量进行容量评估及预测，避免</p>
<p><strong>优点</strong>：</p>
<ul>
<li>实用性：任何一个系统通过这种方法在做准确容量预测的同时，也为系统性能回归测试提供了一个完整的测试场景、测试方法。</li>
<li>准确性：压测流量模拟具备了业务的真实性、全面性。</li>
<li>高效性:所有的建模、压测、到分析及预测，都基于同一个平台，同一种监控方式，同一种分析方法，一切都是自动化，效率比常规高。</li>
</ul>
<h3 id="五、全链路压测平台">五、全链路压测平台</h3>
<p>全链路压测主要对零点峰值流量进行评估、以及对网站承压能力进行测试，主要包括以下几点：</p>
<h3 id="基础数据抽离">1.基础数据抽离</h3>
<p>模拟业务场景真实性</p>
<h3 id="链路与模拟构造">2.链路与模拟构造</h3>
<p>同一条链路需要构造海量的参数集合，模拟不同用户的不同行为。</p>
<h3 id="链路验证">3.链路验证</h3>
<p>每一条链路需要确保能够让链路压测通过</p>
<h3 id="业务代码改造">4.业务代码改造</h3>
<p>压测发现问题，系统及时修改，例如：有些链路并非是幂等的，再比如：下游写流量的拦截等</p>
<h3 id="数据平台">5.数据平台</h3>
<p>数据平台是全链路压测的数据基地，有数据准备、链路的构造、模型的构造组成。</p>
<h3 id="流量平台">6.流量平台</h3>
<p>流量平台是全链路压测的cpu,主要由两个部件构成：</p>
<ul>
<li>全链路压测操控中心， 进行压测的配置和操控、数据的监控以及对压测引擎集群的管控。</li>
<li>压测引擎，由控制台统一管控。</li>
</ul>
<h3 id="影子表">7.影子表</h3>
<p>数据隔离是全链路压测诞生阶段的一大难题。全链路压测的链路有读有写，并且在线上进行，为了不污染到线上的正常数据，全链路压测在同一个数据库实例上对数据表建同样结构的影子表进行数据隔离。</p>
<h3 id="中间件改造">8.中间件改造</h3>
<p>中间件需要对压测流量支持，使得压测标识能够随着调用传递下去，使得下游的应用、基础中间件和存储都能识别压测流量。</p>
<h3 id="安全机制">9.安全机制</h3>
<ul>
<li>1.安全的监控和保护，建立非法流量的监控机制，正常用户访问不到测试数据，测试用户访问不到正常数据，防止数据错乱，并设置压测引擎白名单，防止恶意访问</li>
<li>
<ol start="2">
<li>对压测流量安全过滤，针对压测流量放松安全策略，使得压测流量不被判别为恶意流量</li>
</ol>
</li>
</ul>
<h3 id="六、业务一致性平台">六、业务一致性平台</h3>
<p><strong>场景：</strong><br>
双十一下单，使用扣减10元优惠券，结果某些逻辑出错了，没有扣减，反而多扣了客户的钱，客户反馈上来然后修改。<br>
<strong>解决：</strong><br>
面对这些业务数据不一致问题，业务稳定性保障迫在眉睫，要解决这个问题，需要实时监测业务不一致问题，在客户发现问题之前系统应该发出报警，也行在用户投诉的时候，这个问题已经解决了。这样背景下：实时审计平台（Bussiness Check Platform） BCP 诞生了。它的使命：</p>
<ul>
<li>
<ol>
<li>实时性发现业务脏数据或错误逻辑实现，第一时间通知技术人员而不是等客户反馈</li>
</ol>
</li>
<li>2.方便接入各种有业务规则，通过脚步编写方式，让各个应用快速接入</li>
<li>3.整合订正工具，形成规范的脏数据订正流程</li>
<li>4.业务上线的实时监控，新上线业务可以很方便地进行校验。</li>
</ul>
<p><strong>实现：</strong><br>
BCP 通过时间模型，把业务数据变化触发的消息(如：mq)转换成相应的业务类型事件，放入到事件执行队列进行规则检查。<br>
流程： 数据触发(db变更、mq消息、日志消息等)----&gt;事件构造----&gt;规则获取----&gt;规则运行----&gt;结果存储—&gt;是否报警。</p>
<h2 id="下一章：共享服务中心对内和对外的协作共享">下一章：共享服务中心对内和对外的协作共享</h2>
<blockquote>
<p>reference:<br>
《企业IT架构转型之道》</p>
</blockquote>

