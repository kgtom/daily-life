## 学习大纲
* [一、概况](#1)
* [二、事务回滚](#2)
* [三、代码库回滚](#3)
* [四、部署版本回滚](#4)
* [五、数据版本回滚](#5)
* [六、静态资源版本回滚](#6)
* [七、总结](#7)


## <span id="1">一、概况</span>
回滚是指当程序或数据出错时，将程序或数据恢复到最近一个正确版本的行为。最常见的如：
事务回滚、代码库回滚、部署版本回滚、数据版本回滚、静态资源版本回滚等。通过回滚保证系统在某个场景下的高可用。

## <span id="2">二、事务回滚</span>
目的：保持数据的最终一致性。

* 单库事务直接sql回滚
* 分布式数据库最常见：两阶段提交、三阶段提交、消息队列、事后补偿等实现最终的一致性
例如购买机票结算流程：
   提交订单
   --->调用优惠券服务，成功了调用下一个，
   --->调用库存服务，成功了调用下一个，
   --->调用订单服务
   - 1.三个服务如果其中失败了，则回滚之前的，如果最后一个失败了，服务器挂了，这个时候需要从本地记录事务日志进行分析，然后回滚。或者定期扫描优惠券和库存表，回滚没有关联的订单或者已经取消的订单。
   - 2.下单后一直没有支付，比如30分钟，此时就要定期扫描订单表，然后回滚优惠券和库存服务。
   
  
## <span id="3">二、代码库回滚</span>
  * 1.使用SVN集中式版本控制和Git分布式版本控制管理代码
  * 2.使用分支功能，各自在分支开发，最后合并主分支
  * 3.发现问题、定位问题、回滚版本

## <span id="4">四、部署版本回滚</span>
* 部署版本变化：发布时应该采用全量发布，避免增量发布(只发布修改的类或者文件)。如有需要，全量版本可直接回滚，不会受到约束或限制 
* 小版本增量发布：比如修改bug,添加一些简单的业务逻辑，这些我们叫小版本。增量发布意思是如果我们有100台机器，先发布1台验证，没有问题的话，再接着发布10台，最后全量发布。
* 大版本灰度发布：两个版本并行跑一段时间，如发现其中有问题，则快速切换到另一个。
* 架构升级并行发布：接入层使用Nginx，有新旧两套集群，两者并行，新集群没有问题后，在将流量(%1-->10%-->50%-->100%)逐渐切换到新版本。

## <span id="5">五、数据版本回滚</span>
